DECLARE @Fecha1 DATE = '2024-05-20';
DECLARE @Fecha2 DATE = '20240520';


SELECT  
    CASE 
        WHEN A.TIPOPROD = 'A' THEN  '2100'
        ELSE 
            CASE 
                WHEN A.TIPOPROD = 'B' THEN  '2101' 
            END 
    END COD,
    41 CIA,C.FECHA,C.CUENTA RESERV,1 TIP,'333333333' TERCERO,'001' SUC,'' NAC,CONVERT(int,C.VVENTA) VALOR,9999 HAB,
    C.TIQUETE RECIBO,C.CONSUID TRX_NO,C.tiquete FACTURA,P.descripcion REFERENCIA,A.TIPOPROD NOTAS,'' NRO_TARJETA,'' AUTORIZACION,
    NULL FECHA_DE_VENC,'' FACT_ASOC,'POS' TIPO_DOC,C.VVENTA VALOR_ME,'' DISPLAY_NAME,'' NOMBRE,'' address1,'' city,'' country,'' phone_no
FROM 
    ps_consumos C
INNER JOIN 
    ps_cuentas Q ON c.FECHA = Q.FECHA AND C.CODCAJA = Q.CODCAJA AND C.CUENTA = Q.CUENTA
INNER JOIN 
    Ps_producto P ON C.CODPRODUCTO = P.CODPRODUCTO
INNER JOIN 
    Ps_Agrupa A ON A.CODAGRUPA = P.CODAGRUPA
WHERE 
    C.fecha = @Fecha2 
    AND C.TRANSFERID IS NULL  
    AND C.PLAZA <>'ATN'  
    AND C.VVENTA >0

	UNION 

  SELECT 8 COD,41 CIA,U.FECHA,U.cuenta RESERV,1 TIP,'333333333' TERCERO,
    '001' SUC,'' NAC,CONVERT(int,U.SERVICIO) VALOR,9999 HAB,U.CODIGO_EVE RECIBO,U.CUENTA TRX_NO,
    U.FACTURA FACTURA,U.MOTIVO REFERENCIA,U.MOTIVO NOTAS,'' NRO_TARJETA,'' AUTORIZACION,U.FECHA FECHA_DE_VENC,'' FACT_ASOC,
    '' TIPO_DOC,U.SERVICIO/2 VALOR_ME,'' DISPLAY_NAME,U.TITULAR NOMBRE,
    (SELECT Max(direcc_cli) FROM Clientes C WHERE  C.ident_cli = U.CEDULA) address1,
    (SELECT Max(codciud) FROM Clientes C WHERE  C.ident_cli = U.CEDULA) city,
    (SELECT Max(codpais) FROM Clientes C WHERE  C.ident_cli = U.CEDULA) country,
    U.TELEFONO phone_no FROM   Ps_Cuentas U 
WHERE U.fecha = @Fecha2 AND U.SERVICIO <> 0

UNION 

 select  M.CCARGO_CAR COD , 41 CIA,M.FECHA,  M.nfolio RESERV, 1 TIP, M.IDENT_CLI TERCERO, '001' SUC,
'' NAC, CONVERT(int,( CASE WHEN dbcr = 'D' THEN 1 ELSE -1 END * valor )) VALOR,'9999' HAB,CONVERT(VARCHAR(10), recibocaj) RECIBO, 
nroregis TRX_NO, 12344 FACTURA, M.MOTIVO REFERENCIA, M.MOTIVO NOTAS,M.tcre NRO_TARJETA, M.autor AUTORIZACION,
M.vcto FECHA_DE_VENC,'' FACT_ASOC,'' TIPO_DOC,  ( CASE WHEN dbcr = 'D' THEN 1 ELSE -1 END * valor ) VALORME,

(SELECT Max(nombre_cli) FROM Clientes C WHERE  C.IDENT_CLI = M.IDENT_CLI) DISPLAY_NAME, '' NOMBRE,
 (SELECT Max(direcc_cli) FROM Clientes C WHERE  C.ident_cli = M.ident_cli) address1,
 (SELECT Max(codciud)FROM Clientes C WHERE  C.ident_cli = M.ident_cli) city,
 (SELECT Max(codpais)FROM Clientes C WHERE  C.ident_cli = M.ident_cli) country,
 (SELECT Max(telef_cli)FROM Clientes C WHERE  C.ident_cli = M.ident_cli) phone_no
 
 from Movfolio  M WHERE M.fecha=@Fecha1 and M.CCARGO_CAR= 1100


 UNION 

SELECT 5016 COD,41 CIA,fecha,C.cuenta RESERV,1 TIP,'333333333' TERCERO,'001' SUC,'' NAC,CONVERT(int,C.propinapagada)    VALOR,
9999 HAB,CONVERT(VARCHAR(10), tiquete)  RECIBO,consuid TRX_NO,tiquete FACTURA,'PROPINA POS' REFERENCIA, C.codcentro + '-' + ' PROPINA' NOTAS,
'' NRO_TARJETA,'' AUTORIZACION,NULL FECHA_DE_VENC,'' FACT_ASOC,'POS' TIPO_DOC,0 VALOR_ME,'' DISPLAY_NAME,'' NOMBRE,'' address1,
'' city,''      country,'' phone_no
FROM   ps_consumos C WHERE  fecha = @Fecha2 AND PLAZA =' ' AND propinapagada <> 0 and TRANSFERIDO is null 

 
 UNION
 -- FORMAS DE PAGO 

--EFECTIVO MARRAKECH
SELECT '9100'  COD,41 CIA,C.FECHA,C.CUENTA RESERV,1 TIP,'333333333' TERCERO,'001' SUC,'' NAC,CONVERT(int,C.VVENTA*-1) VALOR,9999 HAB,C.TIQUETE RECIBO,
C.CONSUID TRX_NO,C.tiquete FACTURA,P.descripcion REFERENCIA,A.TIPOPROD NOTAS,'' NRO_TARJETA,'' AUTORIZACION,NULL FECHA_DE_VENC,'' FACT_ASOC,
'POS' TIPO_DOC,C.VVENTA VALOR_ME,'' DISPLAY_NAME,'' NOMBRE,'' address1,'' city,'' country,'' phone_no
FROM ps_consumos C
LEFT JOIN ps_cuentas Q ON c.FECHA = Q.FECHA AND C.CODCAJA = Q.CODCAJA AND C.CUENTA = Q.CUENTA
LEFT JOIN Ps_producto P ON C.CODPRODUCTO = P.CODPRODUCTO
LEFT JOIN  Ps_Agrupa A ON A.CODAGRUPA = P.CODAGRUPA
WHERE C.fecha = @Fecha2 AND TRANSFERID <> 'B' AND CODFPGO = 'EFE'

UNION  

--TARJETA VISA 
 SELECT '9106'  COD,41 CIA,C.FECHA,C.CUENTA RESERV,1 TIP,'333333333' TERCERO,'001' SUC,'' NAC,CONVERT(int,C.VVENTA*-1) VALOR,9999 HAB,C.TIQUETE RECIBO,
C.CONSUID TRX_NO,C.tiquete FACTURA,P.descripcion REFERENCIA,A.TIPOPROD NOTAS,'' NRO_TARJETA,'' AUTORIZACION,NULL FECHA_DE_VENC,
'' FACT_ASOC,'POS' TIPO_DOC,C.VVENTA VALOR_ME,'' DISPLAY_NAME,'' NOMBRE,'' address1,'' city,'' country,'' phone_no
FROM ps_consumos C
LEFT JOIN ps_cuentas Q ON c.FECHA = Q.FECHA AND C.CODCAJA = Q.CODCAJA AND C.CUENTA = Q.CUENTA
LEFT JOIN Ps_producto P ON C.CODPRODUCTO = P.CODPRODUCTO
LEFT JOIN  Ps_Agrupa A ON A.CODAGRUPA = P.CODAGRUPA
WHERE C.fecha = @Fecha2 AND CODFPGO IN('TDV','TCV')

UNION
--TARJETA MASTER 
SELECT '9109'  COD,41 CIA,C.FECHA,C.CUENTA RESERV,1 TIP,'333333333' TERCERO,'001' SUC,'' NAC,CONVERT(int,C.VVENTA*-1) VALOR,9999 HAB,C.TIQUETE RECIBO,
C.CONSUID TRX_NO,C.tiquete FACTURA,P.descripcion REFERENCIA,A.TIPOPROD NOTAS,'' NRO_TARJETA,'' AUTORIZACION,NULL FECHA_DE_VENC,
'' FACT_ASOC,'POS' TIPO_DOC,C.VVENTA VALOR_ME,'' DISPLAY_NAME,'' NOMBRE,'' address1,'' city,'' country,'' phone_no
FROM ps_consumos C
LEFT JOIN ps_cuentas Q ON c.FECHA = Q.FECHA AND C.CODCAJA = Q.CODCAJA AND C.CUENTA = Q.CUENTA
LEFT JOIN Ps_producto P ON C.CODPRODUCTO = P.CODPRODUCTO
LEFT JOIN  Ps_Agrupa A ON A.CODAGRUPA = P.CODAGRUPA
WHERE C.fecha = @Fecha2 AND CODFPGO IN ('TDM','TCM')

union 

--TARJETA AMERICAN EXPRESS
SELECT '9107'  COD,41 CIA,C.FECHA,C.CUENTA RESERV,1 TIP,'333333333' TERCERO,'001' SUC,'' NAC,CONVERT(int,C.VVENTA*-1) VALOR,9999 HAB,C.TIQUETE RECIBO,
C.CONSUID TRX_NO,C.tiquete FACTURA,P.descripcion REFERENCIA,A.TIPOPROD NOTAS,'' NRO_TARJETA,'' AUTORIZACION,NULL FECHA_DE_VENC,
'' FACT_ASOC,'POS' TIPO_DOC,C.VVENTA VALOR_ME,'' DISPLAY_NAME,'' NOMBRE,'' address1,'' city,'' country,'' phone_no
FROM ps_consumos C
LEFT JOIN ps_cuentas Q ON c.FECHA = Q.FECHA AND C.CODCAJA = Q.CODCAJA AND C.CUENTA = Q.CUENTA
LEFT JOIN Ps_producto P ON C.CODPRODUCTO = P.CODPRODUCTO
LEFT JOIN  Ps_Agrupa A ON A.CODAGRUPA = P.CODAGRUPA
WHERE C.fecha = @Fecha2 AND CODFPGO IN ('TDA','TCA')












